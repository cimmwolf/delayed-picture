<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="delayed-element.html">

<dom-module id="delayed-picture">
    <template>
        <style>
            :host {
                /* workaround for Edge intersectionObserverApi bug*/
                display: inline-block;
                min-width: 1px;
            }
        </style>
        <slot></slot>
    </template>
    <script>
        class DelayedPicture extends DelayedElement {
            static get is() {
                return 'delayed-picture'
            }

            static get properties() {
                return {
                    alt: {type: String, value: ''}
                }
            }

            load() {
                let sources = [];
                for (let i = 0, len = this.children.length; i < len; i++) {
                    if (this.children[i].tagName === 'SOURCE') {
                        sources.push(this.children[i]);
                    }
                }
                if (sources.length > 0) {
                    let picture = document.createElement('picture');
                    let img = document.createElement('img');
                    img.setAttribute('alt', this.alt);
                    img.className = this.className;
                    this.removeAttribute('class');
                    this.removeAttribute('alt');

                    for (let i = 0, len = sources.length; i < len; i++) {
                        let source = sources[i];
                        if (!source.getAttribute('srcset')) {
                            source.setAttribute('srcset', source.getAttribute('src'));
                        }
                        source.removeAttribute('src');
                        picture.appendChild(source);
                    }

                    picture.appendChild(img);
                    this.appendChild(picture);
                }
            }
        }

        customElements.define(DelayedPicture.is, DelayedPicture);
    </script>
</dom-module>
